<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Schedule History - Saturday Schedule</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            :root {
                --investment-blue: #003366;
                --attentive-gold: #FFD700;
                --light-gray: #f0f2f5;
                --dark-gray: #333;
            }

            body {
                font-family: 'Inter', sans-serif;
                background-color: var(--light-gray);
                color: var(--dark-gray);
            }

            .header {
                background-color: var(--investment-blue);
                color: white;
            }

            .button-red {
                background-color: #dc2626;
                color: white;
                font-weight: bold;
                transition: background-color 0.3s;
            }

            .button-red:hover {
                background-color: #b91c1c;
            }

            .card {
                background-color: white;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }

            .nav-link {
                color: var(--attentive-gold);
                text-decoration: none;
                font-weight: 500;
                transition: color 0.3s;
            }

            .nav-link:hover {
                color: white;
            }

            .history-item {
                border-left: 4px solid var(--attentive-gold);
            }

        </style>
    </head>

    <body class="flex flex-col min-h-screen">
        <header class="header p-4 shadow-md">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold">Schedule History</h1>
                <nav>
                    <a href="./mainpage.html" class="nav-link mx-2">Main Page</a>
                    <a href="./workload-tracker.html" class="nav-link mx-2">Workload Tracker</a>
                </nav>
            </div>
        </header>

        <main class="flex-grow container mx-auto p-4 md:p-8">
            <div class="card p-6 max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-investment-blue">Past Schedules</h2>
                    <button id="clearHistoryBtn" class="button-red py-2 px-4 rounded-md">Clear History</button>
                </div>
                <div id="historyList" class="space-y-4">
                    <!-- History items will be injected here -->
                </div>
                <div id="messageBox" class="hidden mt-4 p-3 rounded-md text-center"></div>
            </div>
        </main>

        <footer class="bg-gray-200 text-center p-4">
            <p class="text-sm text-gray-600">&copy; 2024 Saturday Schedule App. All rights reserved.</p>
        </footer>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, collection, onSnapshot, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'saturday-schedule-app';

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            let userId = null;
            let unsubscribeHistory = null;

            const historyList = document.getElementById('historyList');
            const clearHistoryBtn = document.getElementById('clearHistoryBtn');
            const messageBox = document.getElementById('messageBox');

            function showMessage(message, isError = false) {
                messageBox.textContent = message;
                messageBox.className = `mt-4 p-3 rounded-md text-center ${ isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700' }`;
                messageBox.classList.remove('hidden');
                setTimeout(() => messageBox.classList.add('hidden'), 3000);
            }

            function displayHistory(schedules) {
                historyList.innerHTML = '';
                if (schedules.length === 0) {
                    historyList.innerHTML = '<p class="text-gray-500 text-center">No schedule history found.</p>';
                    return;
                }

                // Sort schedules by date, most recent first
                schedules.sort((a, b) => new Date(b.date) - new Date(a.date));

                schedules.forEach(schedule => {
                    const scheduleDate = new Date(schedule.date).toLocaleDateString('en-US', { timeZone: 'UTC', weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    const item = `
                    <div class="history-item bg-gray-50 p-4 rounded-r-md">
                        <h3 class="font-bold text-lg text-investment-blue">${ scheduleDate }</h3>
                        <p class="mt-1"><strong>MOD:</strong> ${ schedule.mod }</p>
                        <p><strong>Fillers:</strong> ${ schedule.fillers.join(', ') }</p>
                    </div>
                `;
                    historyList.innerHTML += item;
                });
            }

            clearHistoryBtn.addEventListener('click', async () => {
                if (!userId) return;
                if (confirm("Are you sure you want to clear all schedule history? This action cannot be undone.")) {
                    const historyCollectionRef = collection(db, "artifacts", appId, "users", userId, "history");
                    try {
                        const querySnapshot = await getDocs(historyCollectionRef);
                        const batch = writeBatch(db);
                        querySnapshot.forEach((doc) => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        showMessage("Schedule history cleared successfully.", false);
                    } catch (error) {
                        console.error("Error clearing history: ", error);
                        showMessage("Failed to clear history.", true);
                    }
                }
            });

            function setupHistoryListener() {
                if (unsubscribeHistory) unsubscribeHistory();

                const historyCollectionRef = collection(db, "artifacts", appId, "users", userId, "history");
                unsubscribeHistory = onSnapshot(historyCollectionRef, (querySnapshot) => {
                    const schedules = [];
                    querySnapshot.forEach((doc) => {
                        schedules.push({ id: doc.id, ...doc.data() });
                    });
                    displayHistory(schedules);
                }, (error) => {
                    console.error("Error listening to history updates:", error);
                    showMessage("Could not load schedule history.", true);
                });
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    setupHistoryListener();
                } else {
                    try {
                        const userCredential = await signInAnonymously(auth);
                        userId = userCredential.user.uid;
                        setupHistoryListener();
                    } catch (error) {
                        console.error("Anonymous sign-in failed:", error);
                        showMessage("Could not connect to the server. Please refresh the page.", true);
                    }
                }
            });
        </script>
    </body>

</html>
