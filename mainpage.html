<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Saturday Schedule App</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            :root {
                --investment-blue: #003366;
                --attentive-gold: #FFD700;
                --light-gray: #f0f2f5;
                --dark-gray: #333;
            }

            body {
                font-family: 'Inter', sans-serif;
                background-color: var(--light-gray);
                color: var(--dark-gray);
            }

            .header {
                background-color: var(--investment-blue);
                color: white;
            }

            .button-gold {
                background-color: var(--attentive-gold);
                color: var(--investment-blue);
                font-weight: bold;
                transition: background-color 0.3s;
            }

            .button-gold:hover {
                background-color: #e6c300;
            }

            .button-blue {
                background-color: var(--investment-blue);
                color: white;
                transition: background-color 0.3s;
            }

            .button-blue:hover {
                background-color: #004488;
            }

            .card {
                background-color: white;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }

            .nav-link {
                color: var(--attentive-gold);
                text-decoration: none;
                font-weight: 500;
                transition: color 0.3s;
            }

            .nav-link:hover {
                color: white;
            }

        </style>
    </head>

    <body class="flex flex-col min-h-screen">
        <header class="header p-4 shadow-md">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold">Saturday Schedule App</h1>
                <nav>
                    <a href="./workload-tracker.html" class="nav-link mx-2">Workload Tracker</a>
                    <a href="./saturdayschedulehistory.html" class="nav-link mx-2">Schedule History</a>
                </nav>
            </div>
        </header>

        <main class="flex-grow container mx-auto p-4 md:p-8">
            <div class="card p-6 max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold mb-4 text-center text-investment-blue">Generate New Schedule</h2>
                <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-6">
                    <input type="date" id="scheduleDate" class="p-2 border rounded-md w-full sm:w-auto">
                    <button id="generateBtn" class="button-gold py-2 px-4 rounded-md w-full sm:w-auto">Generate
                        Schedule</button>
                </div>

                <div id="scheduleOutput" class="mt-6 hidden">
                    <h3 class="text-xl font-semibold mb-2 text-investment-blue">Generated Schedule for <span
                            id="displayDate"></span></h3>
                    <div id="generatedSchedule" class="p-4 border-l-4 border-attentive-gold bg-gray-50 rounded-md">
                        <!-- Schedule will be injected here -->
                    </div>
                    <div class="text-center mt-6">
                        <button id="submitBtn" class="button-blue py-2 px-6 rounded-md">Submit Schedule</button>
                    </div>
                </div>
                <div id="messageBox" class="hidden mt-4 p-3 rounded-md text-center"></div>
            </div>
        </main>

        <footer class="bg-gray-200 text-center p-4">
            <p class="text-sm text-gray-600">&copy; 2024 Saturday Schedule App. All rights reserved.</p>
        </footer>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

            // Temporary Firebase config - replace with your actual Firebase project config
            const firebaseConfig = {
                // Add your Firebase config here
                // For now, we'll make the app work without Firebase
            };
            const appId = 'saturday-schedule-app';

            let app, auth, db;
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                }
            } catch (error) {
                console.warn("Firebase not configured, running in local mode:", error);
            }

            let userId = null;
            let generatedScheduleData = null;

            const teamMembers = [
                "Cody", "Jacob", "Veronica", "Vicky","Mikayla", "Rita","Karen"
            ];
            const mods = ["Mitch", "Amy", "Nick","Shawan"]; // Subset of team members who can be MOD

            const generateBtn = document.getElementById('generateBtn');
            const submitBtn = document.getElementById('submitBtn');
            const scheduleDate = document.getElementById('scheduleDate');
            const scheduleOutput = document.getElementById('scheduleOutput');
            const generatedScheduleDiv = document.getElementById('generatedSchedule');
            const displayDate = document.getElementById('displayDate');
            const messageBox = document.getElementById('messageBox');

            function showMessage(message, isError = false) {
                messageBox.textContent = message;
                messageBox.className = `mt-4 p-3 rounded-md text-center ${ isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700' }`;
                messageBox.classList.remove('hidden');
                setTimeout(() => messageBox.classList.add('hidden'), 3000);
            }

            async function getWorkloadTracker() {
                if (!userId || !db) {
                    // Return a default workload tracker for local testing
                    const initialTracker = {};
                    teamMembers.forEach(member => initialTracker[member] = 0);
                    return initialTracker;
                }

                const docRef = doc(db, "artifacts", appId, "users", userId, "workload", "tracker");
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        return docSnap.data();
                    } else {
                        // Initialize if it doesn't exist
                        const initialTracker = {};
                        teamMembers.forEach(member => initialTracker[member] = 0);
                        await setDoc(docRef, initialTracker);
                        return initialTracker;
                    }
                } catch (error) {
                    console.warn("Error accessing Firebase, using local data:", error);
                    const initialTracker = {};
                    teamMembers.forEach(member => initialTracker[member] = 0);
                    return initialTracker;
                }
            }

            generateBtn.addEventListener('click', async () => {
                if (!scheduleDate.value) {
                    showMessage("Please select a date.", true);
                    return;
                }

                const date = new Date(scheduleDate.value);
                // Adjust for timezone to avoid off-by-one day errors
                const utcDate = new Date(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate());
                const dayOfMonth = utcDate.getDate();

                const peopleNeeded = (dayOfMonth >= 1 && dayOfMonth <= 3) ? 5 : 4;
                const fillersNeeded = peopleNeeded - 1;

                const workload = await getWorkloadTracker();

                // Sort members by workload to ensure fairness
                const sortedMembers = [...teamMembers].sort((a, b) => (workload[a] || 0) - (workload[b] || 0));
                const sortedMods = [...mods].sort((a, b) => (workload[a] || 0) - (workload[b] || 0));

                // Select MOD from the least worked MODs
                const selectedMod = sortedMods[0];

                // Select Fillers from the rest of the team, excluding the MOD
                const potentialFillers = sortedMembers.filter(m => m !== selectedMod);
                const selectedFillers = potentialFillers.slice(0, fillersNeeded);

                generatedScheduleData = {
                    date: scheduleDate.value,
                    mod: selectedMod,
                    fillers: selectedFillers
                };

                displayDate.textContent = new Date(scheduleDate.value).toLocaleDateString('en-US', { timeZone: 'UTC', weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                generatedScheduleDiv.innerHTML = `
                <p><strong>Manager on Duty (MOD):</strong> ${ generatedScheduleData.mod }</p>
                <p><strong>Fillers:</strong> ${ generatedScheduleData.fillers.join(', ') }</p>
            `;
                scheduleOutput.classList.remove('hidden');
            });

            submitBtn.addEventListener('click', async () => {
                if (!generatedScheduleData) {
                    showMessage("Please generate a schedule first.", true);
                    return;
                }

                if (!db) {
                    showMessage("Schedule generated successfully! (Firebase not configured - data not saved)", false);
                    scheduleOutput.classList.add('hidden');
                    generatedScheduleData = null;
                    scheduleDate.value = '';
                    return;
                }

                try {
                    // 1. Save to history
                    await addDoc(collection(db, "artifacts", appId, "users", userId, "history"), generatedScheduleData);

                    // 2. Update workload tracker
                    const trackerRef = doc(db, "artifacts", appId, "users", userId, "workload", "tracker");
                    const workload = await getWorkloadTracker();

                    const newWorkload = { ...workload };
                    newWorkload[generatedScheduleData.mod] = (newWorkload[generatedScheduleData.mod] || 0) + 1;
                    generatedScheduleData.fillers.forEach(filler => {
                        newWorkload[filler] = (newWorkload[filler] || 0) + 1;
                    });

                    await setDoc(trackerRef, newWorkload);

                    showMessage("Schedule submitted successfully!", false);
                    scheduleOutput.classList.add('hidden');
                    generatedScheduleData = null;
                    scheduleDate.value = '';

                } catch (error) {
                    console.error("Error submitting schedule: ", error);
                    showMessage("Failed to submit schedule. Please try again.", true);
                }
            });

            if (auth) {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        try {
                            const userCredential = await signInAnonymously(auth);
                            userId = userCredential.user.uid;
                        } catch (error) {
                            console.error("Anonymous sign-in failed:", error);
                            showMessage("Could not connect to the server. Please refresh the page.", true);
                        }
                    }
                });
            } else {
                // Set a default userId for local testing
                userId = 'local-user-' + Math.random().toString(36).substr(2, 9);
                console.log("Running in local mode with userId:", userId);
            }

        </script>
    </body>

</html>
